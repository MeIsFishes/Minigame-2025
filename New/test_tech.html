<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘æŠ€ç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #1a1a2e;
            color: #eee;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background-color: #2a2a4e;
            border-radius: 8px;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #1a1a3e;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            color: #4CAF50;
        }
        .error {
            color: #f44336;
        }
        .info {
            color: #2196F3;
        }
    </style>
</head>
<body>
    <h1>ç§‘æŠ€ç³»ç»Ÿæµ‹è¯•</h1>

    <div class="section">
        <h2>1. ç³»ç»Ÿåˆå§‹åŒ–æµ‹è¯•</h2>
        <button onclick="testInitialization()">æµ‹è¯•åˆå§‹åŒ–</button>
        <div id="init-result" class="result"></div>
    </div>

    <div class="section">
        <h2>2. æ·»åŠ èµ„æºå¹¶å‡çº§</h2>
        <button onclick="addResources()">æ·»åŠ èµ„æºï¼ˆé“100ï¼Œé“œ100ï¼‰</button>
        <button onclick="testUpgrade()">å‡çº§é€Ÿå°„ç‚®ä¼¤å®³</button>
        <div id="upgrade-result" class="result"></div>
    </div>

    <div class="section">
        <h2>3. æŸ¥çœ‹æ­¦å™¨å±æ€§</h2>
        <button onclick="viewWeaponStats('BASIC_GUN')">æŸ¥çœ‹é€Ÿå°„ç‚®</button>
        <button onclick="viewWeaponStats('SHOTGUN')">æŸ¥çœ‹éœ°å¼¹æª</button>
        <button onclick="viewWeaponStats('MISSILE')">æŸ¥çœ‹å¯¼å¼¹</button>
        <div id="weapon-result" class="result"></div>
    </div>

    <div class="section">
        <h2>4. éªŒè¯å‡çº§åº”ç”¨</h2>
        <button onclick="verifyUpgradeApplication()">éªŒè¯å‡çº§æ˜¯å¦åº”ç”¨åˆ°æ­¦å™¨</button>
        <div id="verify-result" class="result"></div>
    </div>

    <div class="section">
        <h2>5. å®Œæ•´æµç¨‹æµ‹è¯•</h2>
        <button onclick="fullFlowTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div id="flow-result" class="result"></div>
    </div>

    <!-- åŠ è½½æ¸¸æˆè„šæœ¬ -->
    <script src="player.js"></script>
    <script src="tech.js"></script>
    <script src="weapon.js"></script>

    <script>
        let player, techSystem, weaponSystem;

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
        }

        function clear(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function testInitialization() {
            clear('init-result');
            try {
                // åˆ›å»ºç©å®¶
                player = new Player();
                log('init-result', 'âœ“ ç©å®¶åˆ›å»ºæˆåŠŸ', 'success');

                // åˆ›å»ºç§‘æŠ€ç³»ç»Ÿ
                techSystem = new TechSystem(player);
                log('init-result', 'âœ“ ç§‘æŠ€ç³»ç»Ÿåˆ›å»ºæˆåŠŸ', 'success');

                // åˆ›å»ºæ­¦å™¨ç³»ç»Ÿï¼ˆéœ€è¦canvasï¼‰
                const canvas = document.createElement('canvas');
                weaponSystem = new WeaponSystem(canvas, player);
                weaponSystem.setTechSystem(techSystem);
                log('init-result', 'âœ“ æ­¦å™¨ç³»ç»Ÿåˆ›å»ºæˆåŠŸ', 'success');

                log('init-result', '\nåˆå§‹åŒ–å®Œæˆï¼æ‰€æœ‰ç³»ç»Ÿå°±ç»ªã€‚', 'success');
            } catch (error) {
                log('init-result', `âœ— åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function addResources() {
            clear('upgrade-result');
            if (!player) {
                log('upgrade-result', 'è¯·å…ˆè¿è¡Œç³»ç»Ÿåˆå§‹åŒ–æµ‹è¯•', 'error');
                return;
            }

            player.addResource('iron', 100);
            player.addResource('copper', 100);
            player.addResource('cobalt', 50);
            player.addResource('nickel', 30);

            const resources = player.getAllResources();
            log('upgrade-result', 'âœ“ èµ„æºå·²æ·»åŠ :', 'success');
            log('upgrade-result', JSON.stringify(resources, null, 2), 'info');
        }

        function testUpgrade() {
            if (!techSystem || !player) {
                log('upgrade-result', 'è¯·å…ˆè¿è¡Œç³»ç»Ÿåˆå§‹åŒ–æµ‹è¯•', 'error');
                return;
            }

            const techId = 'BASIC_GUN_DAMAGE';
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡çº§
            const canUpgrade = techSystem.canUpgrade(techId);
            log('upgrade-result', `\næ£€æŸ¥å‡çº§æ¡ä»¶: ${JSON.stringify(canUpgrade, null, 2)}`, 'info');

            if (canUpgrade.success) {
                // æ‰§è¡Œå‡çº§
                const result = techSystem.upgrade(techId);
                if (result.success) {
                    log('upgrade-result', `âœ“ å‡çº§æˆåŠŸï¼å½“å‰ç­‰çº§: ${result.newLevel}`, 'success');
                    
                    // é‡æ–°åˆå§‹åŒ–æ­¦å™¨
                    weaponSystem.initializeWeapons();
                    log('upgrade-result', 'âœ“ æ­¦å™¨å·²é‡æ–°åˆå§‹åŒ–', 'success');
                } else {
                    log('upgrade-result', `âœ— å‡çº§å¤±è´¥: ${result.reason}`, 'error');
                }
            } else {
                log('upgrade-result', `âœ— æ— æ³•å‡çº§: ${canUpgrade.reason}`, 'error');
            }

            // æ˜¾ç¤ºå‰©ä½™èµ„æº
            const resources = player.getAllResources();
            log('upgrade-result', `\nå‰©ä½™èµ„æº: ${JSON.stringify(resources, null, 2)}`, 'info');
        }

        function viewWeaponStats(weaponId) {
            clear('weapon-result');
            if (!techSystem || !weaponSystem) {
                log('weapon-result', 'è¯·å…ˆè¿è¡Œç³»ç»Ÿåˆå§‹åŒ–æµ‹è¯•', 'error');
                return;
            }

            try {
                // è·å–åŸå§‹æ­¦å™¨æ•°æ®
                const originalWeapon = WeaponPresets[weaponId];
                log('weapon-result', `=== ${originalWeapon.name} (${weaponId}) ===`, 'success');
                
                // è·å–ç§‘æŠ€å‡çº§
                const upgrades = techSystem.getWeaponUpgrades(weaponId);
                log('weapon-result', '\nå½“å‰ç§‘æŠ€å‡çº§:', 'info');
                log('weapon-result', JSON.stringify(upgrades, null, 2), 'info');

                // è·å–åº”ç”¨å‡çº§åçš„æ­¦å™¨
                const upgradedWeapon = techSystem.applyUpgradesToWeapon(originalWeapon);
                
                log('weapon-result', '\nåŸå§‹å±æ€§ vs å‡çº§åå±æ€§:', 'info');
                log('weapon-result', `ä¼¤å®³: ${originalWeapon.damage} â†’ ${upgradedWeapon.damage}`, 'info');
                log('weapon-result', `å†·å´: ${originalWeapon.cooldown}ms â†’ ${upgradedWeapon.cooldown}ms`, 'info');
                log('weapon-result', `å­å¼¹æ•°: ${originalWeapon.bulletsPerShot} â†’ ${upgradedWeapon.bulletsPerShot}`, 'info');
                log('weapon-result', `å­å¼¹é€Ÿåº¦: ${originalWeapon.bulletSpeed} â†’ ${upgradedWeapon.bulletSpeed}`, 'info');

                // è·å–è¯¥æ­¦å™¨çš„æ‰€æœ‰ç§‘æŠ€
                const techs = techSystem.getWeaponTechs(weaponId);
                log('weapon-result', '\nç§‘æŠ€ç­‰çº§:', 'info');
                techs.forEach(({ tech, currentLevel }) => {
                    log('weapon-result', `  ${tech.name}: Lv${currentLevel}/${tech.maxLevel}`, 'info');
                });

            } catch (error) {
                log('weapon-result', `âœ— æŸ¥çœ‹å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function verifyUpgradeApplication() {
            clear('verify-result');
            if (!techSystem || !weaponSystem || !player) {
                log('verify-result', 'è¯·å…ˆè¿è¡Œç³»ç»Ÿåˆå§‹åŒ–æµ‹è¯•', 'error');
                return;
            }

            try {
                log('verify-result', '=== éªŒè¯å‡çº§åº”ç”¨ ===', 'success');

                // æ·»åŠ èµ„æº
                player.addResource('iron', 500);
                player.addResource('copper', 500);
                log('verify-result', 'âœ“ æ·»åŠ æµ‹è¯•èµ„æº', 'success');

                // å‡çº§é€Ÿå°„ç‚®ä¼¤å®³åˆ°Lv3
                for (let i = 0; i < 3; i++) {
                    const result = techSystem.upgrade('BASIC_GUN_DAMAGE');
                    if (result.success) {
                        log('verify-result', `âœ“ é€Ÿå°„ç‚®ä¼¤å®³å‡çº§åˆ° Lv${result.newLevel}`, 'success');
                    }
                }

                // é‡æ–°åˆå§‹åŒ–æ­¦å™¨
                weaponSystem.initializeWeapons();
                log('verify-result', 'âœ“ æ­¦å™¨é‡æ–°åˆå§‹åŒ–', 'success');

                // æ£€æŸ¥æ­¦å™¨ç³»ç»Ÿä¸­çš„æ­¦å™¨æ˜¯å¦åº”ç”¨äº†å‡çº§
                const weaponInSystem = weaponSystem.getWeapon('Q');
                const originalWeapon = WeaponPresets['BASIC_GUN'];
                const upgradedWeapon = techSystem.applyUpgradesToWeapon(originalWeapon);

                log('verify-result', '\næ­¦å™¨ç³»ç»Ÿä¸­çš„æ­¦å™¨å±æ€§:', 'info');
                log('verify-result', `ä¼¤å®³: ${weaponInSystem.damage}`, 'info');
                log('verify-result', `æœŸæœ›ä¼¤å®³: ${upgradedWeapon.damage}`, 'info');

                if (weaponInSystem.damage === upgradedWeapon.damage) {
                    log('verify-result', '\nâœ“âœ“âœ“ éªŒè¯æˆåŠŸï¼ç§‘æŠ€å‡çº§å·²æ­£ç¡®åº”ç”¨åˆ°æ­¦å™¨ï¼', 'success');
                } else {
                    log('verify-result', '\nâœ—âœ—âœ— éªŒè¯å¤±è´¥ï¼å‡çº§æœªåº”ç”¨æˆ–åº”ç”¨ä¸æ­£ç¡®ï¼', 'error');
                    log('verify-result', `å®é™…ä¼¤å®³: ${weaponInSystem.damage}, æœŸæœ›ä¼¤å®³: ${upgradedWeapon.damage}`, 'error');
                }

            } catch (error) {
                log('verify-result', `âœ— éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function fullFlowTest() {
            clear('flow-result');
            
            try {
                log('flow-result', '=== å®Œæ•´æµç¨‹æµ‹è¯• ===\n', 'success');

                // 1. åˆå§‹åŒ–
                log('flow-result', 'æ­¥éª¤1: åˆå§‹åŒ–ç³»ç»Ÿ', 'info');
                player = new Player();
                techSystem = new TechSystem(player);
                const canvas = document.createElement('canvas');
                weaponSystem = new WeaponSystem(canvas, player);
                weaponSystem.setTechSystem(techSystem);
                log('flow-result', 'âœ“ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ\n', 'success');

                // 2. æ·»åŠ èµ„æº
                log('flow-result', 'æ­¥éª¤2: æ·»åŠ èµ„æº', 'info');
                player.addResource('iron', 1000);
                player.addResource('copper', 1000);
                player.addResource('cobalt', 500);
                log('flow-result', `âœ“ å½“å‰èµ„æº: ${JSON.stringify(player.getAllResources())}\n`, 'success');

                // 3. æŸ¥çœ‹åˆå§‹æ­¦å™¨å±æ€§
                log('flow-result', 'æ­¥éª¤3: æŸ¥çœ‹é€Ÿå°„ç‚®åˆå§‹å±æ€§', 'info');
                const originalWeapon = WeaponPresets['BASIC_GUN'];
                log('flow-result', `ä¼¤å®³: ${originalWeapon.damage}, å†·å´: ${originalWeapon.cooldown}ms\n`, 'info');

                // 4. å‡çº§ä¼¤å®³
                log('flow-result', 'æ­¥éª¤4: å‡çº§é€Ÿå°„ç‚®ä¼¤å®³', 'info');
                for (let i = 0; i < 5; i++) {
                    const result = techSystem.upgrade('BASIC_GUN_DAMAGE');
                    if (result.success) {
                        log('flow-result', `âœ“ å‡çº§åˆ° Lv${result.newLevel}`, 'success');
                    } else {
                        log('flow-result', `âœ— å‡çº§å¤±è´¥: ${result.reason}`, 'error');
                        break;
                    }
                }

                // 5. å‡çº§å†·å´
                log('flow-result', '\næ­¥éª¤5: å‡çº§é€Ÿå°„ç‚®å†·å´', 'info');
                for (let i = 0; i < 3; i++) {
                    const result = techSystem.upgrade('BASIC_GUN_COOLDOWN');
                    if (result.success) {
                        log('flow-result', `âœ“ å‡çº§åˆ° Lv${result.newLevel}`, 'success');
                    } else {
                        log('flow-result', `âœ— å‡çº§å¤±è´¥: ${result.reason}`, 'error');
                        break;
                    }
                }

                // 6. åº”ç”¨å‡çº§
                log('flow-result', '\næ­¥éª¤6: åº”ç”¨å‡çº§åˆ°æ­¦å™¨', 'info');
                weaponSystem.initializeWeapons();
                log('flow-result', 'âœ“ æ­¦å™¨é‡æ–°åˆå§‹åŒ–å®Œæˆ\n', 'success');

                // 7. éªŒè¯æœ€ç»ˆå±æ€§
                log('flow-result', 'æ­¥éª¤7: éªŒè¯æœ€ç»ˆå±æ€§', 'info');
                const upgradedWeapon = techSystem.applyUpgradesToWeapon(originalWeapon);
                const weaponInSystem = weaponSystem.getWeapon('Q');
                
                log('flow-result', 'åŸå§‹å±æ€§:', 'info');
                log('flow-result', `  ä¼¤å®³: ${originalWeapon.damage}, å†·å´: ${originalWeapon.cooldown}ms`, 'info');
                log('flow-result', 'å‡çº§åå±æ€§:', 'info');
                log('flow-result', `  ä¼¤å®³: ${upgradedWeapon.damage}, å†·å´: ${upgradedWeapon.cooldown}ms`, 'info');
                log('flow-result', 'æ­¦å™¨ç³»ç»Ÿä¸­çš„å±æ€§:', 'info');
                log('flow-result', `  ä¼¤å®³: ${weaponInSystem.damage}, å†·å´: ${weaponInSystem.cooldown}ms`, 'info');

                // 8. æœ€ç»ˆéªŒè¯
                log('flow-result', '\næ­¥éª¤8: æœ€ç»ˆéªŒè¯', 'info');
                const damageMatch = weaponInSystem.damage === upgradedWeapon.damage;
                const cooldownMatch = weaponInSystem.cooldown === upgradedWeapon.cooldown;
                
                if (damageMatch && cooldownMatch) {
                    log('flow-result', '\nğŸ‰ğŸ‰ğŸ‰ å®Œæ•´æµ‹è¯•é€šè¿‡ï¼ç§‘æŠ€ç³»ç»Ÿå·¥ä½œæ­£å¸¸ï¼', 'success');
                } else {
                    log('flow-result', '\nâŒ æµ‹è¯•å¤±è´¥ï¼', 'error');
                    if (!damageMatch) log('flow-result', `ä¼¤å®³ä¸åŒ¹é…: ${weaponInSystem.damage} â‰  ${upgradedWeapon.damage}`, 'error');
                    if (!cooldownMatch) log('flow-result', `å†·å´ä¸åŒ¹é…: ${weaponInSystem.cooldown} â‰  ${upgradedWeapon.cooldown}`, 'error');
                }

                // æ˜¾ç¤ºå‰©ä½™èµ„æº
                log('flow-result', `\nå‰©ä½™èµ„æº: ${JSON.stringify(player.getAllResources())}`, 'info');

            } catch (error) {
                log('flow-result', `\nâœ— æµ‹è¯•è¿‡ç¨‹å‡ºé”™: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
